<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Your Cart</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">

<div class="container mt-5">
    <h2 class="mb-4">ðŸ›’ Your Shopping Cart</h2>

    <!-- Empty Cart -->
    <div th:if="${cartItems.size() == 0}" class="text-center">
        <p class="alert alert-info">Your cart is empty.</p>
        <a href="/products" class="btn btn-primary">Continue Shopping</a>
    </div>

    <!-- Cart Items Table -->
    <div th:if="${cartItems.size() > 0}">
        <table class="table table-bordered table-striped text-center align-middle">
            <thead class="table-dark">
            <tr>
                <th>Image</th>
                <th>Product</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Subtotal</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item : ${cartItems}">
                <td>
                    <img th:src="${item.product.imageUrl}" alt="Product Image" class="img-fluid" style="max-height: 80px;">
                </td>
                <td th:text="${item.product.name}"></td>
                <td>â‚¹<span th:text="${item.product.price}"></span></td>
                <td>
                    <form th:action="@{/cart/update/{id}(id=${item.id})}" method="post" class="d-flex justify-content-center">
                        <input type="number" name="quantity" th:value="${item.quantity}" min="1" class="form-control w-50 text-center me-2">
                        <button type="submit" class="btn btn-sm btn-warning">Update</button>
                    </form>
                </td>
                <td>â‚¹<span th:text="${item.product.price * item.quantity}"></span></td>
                <td>
                    <a th:href="@{/cart/remove/{id}(id=${item.id})}" class="btn btn-sm btn-danger">Remove</a>
                </td>
            </tr>
            </tbody>
        </table>

        <!-- Total Price -->
        <div class="text-end">
            <h4>Total: â‚¹<span id="totalAmount" th:text="${totalPrice}">0</span></h4>
        </div>

        <!-- Checkout and Continue -->
        <div class="d-flex justify-content-end mt-3">
            <button id="checkoutBtn" class="btn btn-success me-2">Proceed to Checkout</button>
            <a href="/products" class="btn btn-secondary">Continue Shopping</a>
        </div>
    </div>
</div>

<!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const checkoutBtn = document.getElementById("checkoutBtn");
    if (!checkoutBtn) return; // No cart items, nothing to bind

    checkoutBtn.addEventListener("click", function () {
        let totalAmount = parseInt(document.getElementById("totalAmount").innerText) * 100;

        fetch(`/api/payment/create-order?amount=${totalAmount}`, {
            method: "POST"
        })
        .then(response => {
            if (!response.ok) throw new Error("Failed to create order");
            return response.json();
        })
        .then(order => {
            let options = {
                key: "YOUR_RAZORPAY_KEY", // Replace with your public key
                amount: order.amount,
                currency: order.currency,
                name: "PreKart",
                description: "Cart Payment",
                order_id: order.id,
                handler: function (response) {
                    fetch("/api/payment/verify", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_signature: response.razorpay_signature
                        })
                    })
                    .then(res => res.text())
                    .then(msg => {
                        alert(msg);
                        if (msg.includes("success")) {
                            window.location.href = "/order/success";
                        }
                    })
                    .catch(err => console.error("Verification error:", err));
                },
                theme: { color: "#3399cc" }
            };
            new Razorpay(options).open();
        })
        .catch(err => console.error("Error creating order:", err));
    });
});
</script>


</body>
</html>
